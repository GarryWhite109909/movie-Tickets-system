# 前端需求文档与开发计划

根据您的要求，我已对数据库结构 (`server-nest/prisma/schema.prisma`) 和前端代码 (`web-new`) 进行了调研。由于当前前端项目使用的是 **Next.js App Router** 架构（而非 Vite），我将使用 **Next.js App Router Expert** 来执行后续的代码编写任务。

以下是为您整理的前端需求文档：

## 1. 全局规范

### 1.1 交互与响应规范
- **统一响应接口**:
  ```typescript
  interface ApiResponse<T> {
    code: number; // 200 为成功，其他为错误码
    msg: string;  // 错误提示或成功消息
    data: T;
  }
  ```
- **错误处理**:
  - API 请求失败 (非 200) -> 弹出全局 Toast 提示 `msg`。
  - Token 失效 (401) -> 自动重定向至 `/login`。
  - 网络异常 -> 提示“网络连接失败，请稍后重试”。

### 1.2 缓存与获取频率策略 (修改 `utils/api.ts`)
- **默认策略**: `no-store` (实时获取，确保数据准确性)。
- **静态/低频数据**: (如影片列表) 使用 `next: { revalidate: 60 }` (60秒缓存)。
- **高频/库存数据**: (如选座、订单) 强制 `cache: 'no-store'`。

---

## 2. 页面/组件需求清单

### 2.1 首页 (`/`) & 影片列表 (`/films`)
- **功能**: 展示热门影片、统计数据、影片列表。
- **数据源**:
  - `GET /stats/overview` (统计)
  - `GET /stats/topFilms` (热门)
  - `GET /film/all` (列表)
- **缓存策略**: `revalidate: 60` (1分钟更新一次即可)。
- **字段清单**:
  | 字段名 | 类型 | 说明 | 来源 (DB/API) | 展示处理 |
  | :--- | :--- | :--- | :--- | :--- |
  | `filmId` | string | 唯一标识 | `Film.filmId` | 跳转 `/booking?filmId=xx` |
  | `filmName` | string | 影片名称 | `Film.filmName` | 截断显示 (CSS) |
  | `poster` | string | 海报URL | `posterimg.url` | 默认图兜底 |
  | `onTime` | string | 上映时间 | `Film.onTime` | 格式化 YYYY-MM-DD |

### 2.2 选座购票页 (`/booking`)
- **功能**: 选择日期、查看排片场次。
- **数据源**:
  - `GET /film/:id` (影片详情)
  - `GET /arrange/film/:id/dates` (排片日期)
  - `GET /arrange/film/:id?date=YYYY-MM-DD` (具体场次)
- **缓存策略**: **`no-store`** (必须实时)。
- **交互要求**:
  - **登录校验**: 进入页面检查 Token，无 Token 跳转登录。
  - **失败兜底**: 排片加载失败显示“暂无排片”或重试按钮。
- **字段清单**:
  | 字段名 | 类型 | 说明 | 来源 | 展示处理 |
  | :--- | :--- | :--- | :--- | :--- |
  | `arrangeId`| string | 排片ID | `arrange.arrangeId`| 传递给选座页 |
  | `roomName` | string | 影厅名 | `filmroom.roomName`| 直接展示 |
  | `start`/`end`| string | 时间 | `arrange.start/end`| 格式 HH:mm |
  | `price` | number | 价格 | `arrange.price` | 保留2位小数 |

### 2.3 用户个人中心 (`/profile`)
- **功能**: 展示用户信息、订单记录。
- **敏感数据脱敏**:
  - **手机号**: `138****1234` (前端掩码处理)。
  - **邮箱**: `a***@example.com`。
  - **密码**: 严禁从后端返回，前端不涉及。
- **缓存策略**: `no-store`。

---

## 3. 待开发/优化任务列表

我将按照以下步骤指示 Agent 进行开发：

1.  **基础设施升级 (`utils/api.ts`)**:
    - 封装支持 `revalidate` 的 fetcher。
    - 统一拦截 401 状态码。
2.  **类型定义同步**:
    - 根据 Prisma Schema 和 API 响应完善 TypeScript 接口定义。
3.  **组件健壮性优化**:
    - `BookingClient.tsx`: 增加错误边界和空状态展示。
    - `FilmCard.tsx`: 增加图片加载失败的默认图逻辑。
4.  **安全加固**:
    - 检查所有涉及用户信息的组件，确保实施脱敏逻辑。

确认计划后，我将调用 `nextjs-app-router-expert` 开始执行。